using System;
using System.Collections.Generic;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;
using Core.Configs;
using Core.Extensions;
using Core.Types.Book;
using Core.Types.Common;
using Core.Types.Dreame;
using HtmlAgilityPack;
using HtmlAgilityPack.CssSelectors.NetCore;
using Microsoft.Extensions.Logging;

namespace Core.Logic.Getters; 

public class DreameGetter(BookGetterConfig config) : GetterBase(config) {
    protected override Uri SystemUrl => new("https://dreame.com/");
    
    private Uri _apiUrl => new($"https://wap-api.{SystemUrl.Host}/");

    protected override string GetId(Uri url) => url.GetSegment(2).Split(".")[0].Split("-")[0];

    public override async Task<Book> Get(Uri url) {
        var bookId = GetId(url);
        url = $"https://www.dreame.com/story/{bookId}".AsUri();
        var doc = await Config.Client.GetHtmlDocWithTriesAsync(url);
        var data = GetNextData<DreameNovel>(doc, "novel");
        
        var book = new Book(url) {
            Cover = await GetCover(data.Cover),
            Chapters = await FillChapters(url, bookId),
            Title = data.Name,
            Author = GetAuthor(doc, data),
            Annotation = data.Description,
            Lang = data.Language
        };
            
        return book;
    }
    
    private static T GetNextData<T>(HtmlDocument doc, string node) {
        var json = doc.QuerySelector("#__NEXT_DATA__").InnerText;
        return JsonDocument.Parse(json)
            .RootElement.GetProperty("props")
            .GetProperty("pageProps")
            .GetProperty("novelInfo")
            .GetProperty(node)
            .GetRawText()
            .Deserialize<T>();
    }
    
    private async Task<IEnumerable<Chapter>> FillChapters(Uri url, string bookId) {
        var result = new List<Chapter>();
        if (Config.Options.NoChapters) {
            return result;
        }

        foreach (var urlChapter in await GetToc(bookId)) {
            Config.Logger.LogInformation($"Загружаю главу {urlChapter.Title.CoverQuotes()}");
            var chapter = new Chapter {
                Title = urlChapter.Title
            };

            var chapterDoc = await GetChapter(urlChapter);
            if (chapterDoc != default) {
                chapter.Images = await GetImages(chapterDoc, url);
                chapter.Content = chapterDoc.DocumentNode.InnerHtml;
            }
            
            result.Add(chapter);
        }

        return result;
    }

    private async Task<HtmlDocument> GetChapter(DreameChapter urlChapter) {
        var response = await Config.Client.GetFromJsonWithTriesAsync<DreameApiResponse<DreameChapter>>(_apiUrl.MakeRelativeUri($"/novel/getChapter?channel=dreamepmian-173&product=1&osType=2&cid={urlChapter.Id}&systemFlag=android&port=web"));
        return Encoding.UTF8.GetString(Convert.FromBase64String(response.Data.Content)).AsHtmlDoc();
    }

    private async Task<IEnumerable<DreameChapter>> GetToc(string bookId) {
        var response = await Config.Client.GetFromJsonWithTriesAsync<DreameApiResponse<DreameCatalog>>(_apiUrl.MakeRelativeUri($"novel/getcatelog?channel=dreamepmian-173&product=1&osType=2&nid={bookId}"));
        return SliceToc(response.Data.Pager.ChapterList, c => c.Title);
    }

    private Author GetAuthor(HtmlDocument doc, DreameNovel data) {
        var a = doc.QuerySelector("a a[class*=story_author-name]");
        return a != default ? 
            new Author(data.AuthorName, SystemUrl.MakeRelativeUri(a.Attributes["href"].Value)) : 
            new Author(data.AuthorName);
    }

    private Task<TempFile> GetCover(string url) {
        return !string.IsNullOrWhiteSpace(url) ? SaveImage(url.AsUri()) : Task.FromResult(default(TempFile));
    }
}